// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// Enum untuk Status CR
enum CRStatus {
  DRAFT
  PENDING_MANAGER
  REJECTED_MANAGER    // Final rejection by manager
  REVISION_MANAGER    // Need revision from manager
  PENDING_VP
  REJECTED_VP         // Final rejection by VP (reset flow)
  REVISION_VP         // Need revision from VP (reset flow)
  APPROVED
  ASSIGNED_DEV
  COMPLETED
  DELETED             // Soft delete
}

// Enum untuk Role User
enum UserRole {
  USER
  MANAGER
  VP
  MANAGER_IT
  DEV
}

// Enum untuk Action di Approval Log
enum ApprovalAction {
  APPROVE
  REJECT
  REQUEST_REVISION
  SUBMIT
  RESUBMIT
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  name         String   @db.VarChar(255)
  passwordHash String   @map("password_hash")
  role         UserRole
  division     String?  @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  changeRequests       ChangeRequest[]
  approvalLogs         ApprovalLog[]
  developerAssignments DeveloperAssignment[] @relation("DeveloperAssignments")
  assignedBy           DeveloperAssignment[] @relation("AssignedBy")
  notifications        Notification[]

  @@map("users")
}

model ChangeRequest {
  id                  String   @id @db.VarChar(20) // Format: CR-YYYY-MM-NNNNNN
  userId              String   @map("user_id") @db.Uuid
  formData            Json     @map("form_data") @db.JsonB
  status              CRStatus @default(DRAFT)
  currentApproverRole String?  @map("current_approver_role") @db.VarChar(50)
  revisionCount       Int      @default(0) @map("revision_count") // Track revision cycles
  managerRevisionCount Int     @default(0) @map("manager_revision_count") // Max 3
  vpRevisionCount     Int      @default(0) @map("vp_revision_count") // Max 2
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User                  @relation(fields: [userId], references: [id])
  approvalLogs         ApprovalLog[]
  developerAssignments DeveloperAssignment[]
  documents            Document[]

  @@map("change_requests")
}

model ApprovalLog {
  id         Int            @id @default(autoincrement())
  crId       String         @map("cr_id") @db.VarChar(20)
  approverId String         @map("approver_id") @db.Uuid
  action     ApprovalAction
  notes      String?        @db.Text
  createdAt  DateTime       @default(now()) @map("created_at")

  // Relations
  changeRequest ChangeRequest @relation(fields: [crId], references: [id])
  approver      User          @relation(fields: [approverId], references: [id])

  @@map("approval_logs")
}

model DeveloperAssignment {
  id          Int      @id @default(autoincrement())
  crId        String   @map("cr_id") @db.VarChar(20)
  developerId String   @map("developer_id") @db.Uuid
  assignedById String  @map("assigned_by") @db.Uuid
  notes       String?  @db.Text
  assignedAt  DateTime @default(now()) @map("assigned_at")

  // Relations
  changeRequest ChangeRequest @relation(fields: [crId], references: [id])
  developer     User          @relation("DeveloperAssignments", fields: [developerId], references: [id])
  assignedBy    User          @relation("AssignedBy", fields: [assignedById], references: [id])

  @@map("developer_assignments")
}

model Document {
  id        Int      @id @default(autoincrement())
  crId      String   @map("cr_id") @db.VarChar(20)
  fileName  String   @map("file_name") @db.VarChar(255)
  filePath  String   @map("file_path") @db.VarChar(500)
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type") @db.VarChar(100)
  fileType  String   @default("ATTACHMENT") @map("file_type") @db.VarChar(50) // ATTACHMENT, PDF_APPROVAL
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  changeRequest ChangeRequest @relation(fields: [crId], references: [id])

  @@map("documents")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id") @db.Uuid
  title     String   @db.VarChar(255)
  message   String   @db.Text
  type      String   @db.VarChar(50) // CR_SUBMITTED, CR_APPROVED, CR_REJECTED, CR_ASSIGNED, etc
  relatedId String?  @map("related_id") @db.VarChar(20) // CR ID if related
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}
